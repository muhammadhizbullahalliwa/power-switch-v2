<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power Switch Control System V2</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar-custom {
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .card {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: none;
            transition: transform 0.3s, box-shadow 0.3s;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        
        .card-header {
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border-bottom: none;
            border-radius: 15px 15px 0 0 !important;
            padding: 15px 20px;
            font-weight: 600;
        }
        
        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            box-shadow: 0 0 10px currentColor;
        }
        
        .status-online {
            background-color: var(--success-color);
            animation: pulse 2s infinite;
        }
        
        .status-offline {
            background-color: var(--danger-color);
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .btn-custom {
            border-radius: 25px;
            font-weight: 600;
            padding: 10px 25px;
            transition: all 0.3s;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        
        .btn-custom:active {
            transform: translateY(0);
        }
        
        .btn-primary-custom {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
        }
        
        .btn-success-custom {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }
        
        .btn-danger-custom {
            background: linear-gradient(45deg, #dc3545, #fd7e14);
            color: white;
        }
        
        .btn-warning-custom {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
            color: white;
        }
        
        .sensor-value {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
        }
        
        .unit {
            font-size: 1rem;
            color: #6c757d;
            font-weight: normal;
        }
        
        .sensor-label {
            font-size: 0.9rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .mode-badge {
            font-size: 0.9rem;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .log-entry {
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
            background: rgba(0,0,0,0.02);
            font-size: 0.9rem;
        }
        
        .log-entry.success {
            border-left-color: var(--success-color);
            background: rgba(40, 167, 69, 0.1);
        }
        
        .log-entry.warning {
            border-left-color: var(--warning-color);
            background: rgba(255, 193, 7, 0.1);
        }
        
        .log-entry.danger {
            border-left-color: var(--danger-color);
            background: rgba(220, 53, 69, 0.1);
        }
        
        .log-entry.info {
            border-left-color: var(--info-color);
            background: rgba(23, 162, 184, 0.1);
        }
        
        .state-badge {
            font-size: 1rem;
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .modal-custom .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .modal-custom .modal-header {
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border-radius: 15px 15px 0 0;
            border-bottom: none;
        }
        
        .progress-bar-custom {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border-radius: 10px;
        }
        
        .tab-content {
            padding: 20px;
            background: white;
            border-radius: 0 0 15px 15px;
        }
        
        .nav-tabs {
            border-bottom: none;
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: #6c757d;
            font-weight: 600;
            padding: 12px 25px;
            border-radius: 10px 10px 0 0;
        }
        
        .nav-tabs .nav-link.active {
            background: white;
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }
        
        .optimalization-status {
            padding: 10px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .status-good {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success-color);
            border: 2px solid var(--success-color);
        }
        
        .status-warning {
            background: rgba(255, 193, 7, 0.1);
            color: var(--warning-color);
            border: 2px solid var(--warning-color);
        }
        
        .status-danger {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger-color);
            border: 2px solid var(--danger-color);
        }
        
        .gauge-container {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto;
        }
        
        .gauge {
            width: 100%;
            height: 100%;
        }
        
        .gauge-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .floating-action-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            font-size: 1.5rem;
            z-index: 1000;
            transition: all 0.3s;
        }
        
        .floating-action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        @media (max-width: 768px) {
            .sensor-value {
                font-size: 1.8rem;
            }
            
            .btn-custom {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
            
            .floating-action-btn {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-bolt me-2"></i>
                <span class="fw-bold">POWER SWITCH CONTROL V2</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#dashboard">
                            <i class="fas fa-tachometer-alt me-1"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#control">
                            <i class="fas fa-gamepad me-1"></i> Control
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#optimalization">
                            <i class="fas fa-sliders-h me-1"></i> Optimalization
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#settings">
                            <i class="fas fa-cog me-1"></i> Settings
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Connection Status Bar -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body py-2">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <span id="status-indicator" class="status-indicator status-offline"></span>
                            <span id="connection-status" class="fw-bold">Disconnected</span>
                        </div>
                        <div class="col-md-6 text-center">
                            <span class="me-3"><i class="fas fa-microchip me-1"></i> ESP32: <span id="esp-ip" class="fw-bold">10.191.170.230</span></span>
                            <span><i class="fas fa-plug me-1"></i> WebSocket: <span id="ws-status" class="fw-bold">Not Connected</span></span>
                        </div>
                        <div class="col-md-3 text-end">
                            <span id="uptime-display"><i class="fas fa-clock me-1"></i> Uptime: --:--:--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container-fluid">
        <!-- Dashboard Section -->
        <div id="dashboard" class="section">
            <div class="row">
                <!-- Left Column: System State & Control -->
                <div class="col-lg-4 col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-power-off me-2"></i>System Power Control</h5>
                        </div>
                        <div class="card-body">
                            <div class="text-center mb-4">
                                <div id="system-state-badge" class="state-badge bg-secondary mb-3">STATE: UNKNOWN</div>
                                <div class="row">
                                    <div class="col-6">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="auto-mode-switch" style="transform: scale(1.5);">
                                            <label class="form-check-label fw-bold" for="auto-mode-switch">Auto Mode</label>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="maintenance-switch" style="transform: scale(1.5);">
                                            <label class="form-check-label fw-bold" for="maintenance-switch">Maintenance</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row g-3">
                                <div class="col-6">
                                    <button class="btn btn-success-custom btn-custom w-100" onclick="controlSwitch('source1')">
                                        <i class="fas fa-bolt me-2"></i>Source 1
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button class="btn btn-warning-custom btn-custom w-100" onclick="controlSwitch('source2')">
                                        <i class="fas fa-bolt me-2"></i>Source 2
                                    </button>
                                </div>
                                <div class="col-12">
                                    <button class="btn btn-danger-custom btn-custom w-100" onclick="controlSwitch('shutdown')">
                                        <i class="fas fa-power-off me-2"></i>Emergency Stop
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <h6><i class="fas fa-info-circle me-2"></i>System Information</h6>
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">WiFi Signal</small>
                                        <div><span id="wifi-rssi">--</span> dBm</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Free Heap</small>
                                        <div><span id="free-heap">--</span> bytes</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Middle Column: Sensor Readings -->
                <div class="col-lg-4 col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Real-time Sensor Data</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <!-- Voltage 1 -->
                                <div class="col-6">
                                    <div class="text-center p-3 border rounded">
                                        <div class="sensor-label"><i class="fas fa-bolt text-warning me-1"></i>Voltage 1</div>
                                        <div class="sensor-value">
                                            <span id="voltage1">0.0</span><span class="unit">V</span>
                                        </div>
                                        <div class="small text-muted mt-1">
                                            <span id="v1-status" class="badge bg-secondary">OFF</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Voltage 2 -->
                                <div class="col-6">
                                    <div class="text-center p-3 border rounded">
                                        <div class="sensor-label"><i class="fas fa-bolt text-warning me-1"></i>Voltage 2</div>
                                        <div class="sensor-value">
                                            <span id="voltage2">0.0</span><span class="unit">V</span>
                                        </div>
                                        <div class="small text-muted mt-1">
                                            <span id="v2-status" class="badge bg-secondary">OFF</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Current -->
                                <div class="col-6">
                                    <div class="text-center p-3 border rounded">
                                        <div class="sensor-label"><i class="fas fa-tachometer-alt text-info me-1"></i>Current</div>
                                        <div class="sensor-value">
                                            <span id="current">0.000</span><span class="unit">A</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Power -->
                                <div class="col-6">
                                    <div class="text-center p-3 border rounded">
                                        <div class="sensor-label"><i class="fas fa-charging-station text-success me-1"></i>Power</div>
                                        <div class="sensor-value">
                                            <span id="power">0.0</span><span class="unit">W</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Energy -->
                                <div class="col-12">
                                    <div class="text-center p-3 border rounded">
                                        <div class="sensor-label"><i class="fas fa-battery-full text-primary me-1"></i>Energy Consumption</div>
                                        <div class="sensor-value">
                                            <span id="energy">0.000</span><span class="unit">kWh</span>
                                        </div>
                                        <div class="progress mt-2" style="height: 8px;">
                                            <div id="energy-progress" class="progress-bar progress-bar-custom" style="width: 0%"></div>
                                        </div>
                                        <small class="text-muted">Energy usage indicator</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: System Status & Log -->
                <div class="col-lg-4 col-md-12">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>System Log</h5>
                            <div>
                                <button class="btn btn-sm btn-outline-light me-2" onclick="clearLog()">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-light" onclick="toggleAutoScroll()">
                                    <i class="fas fa-scroll" id="scroll-icon"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div id="log-panel" style="height: 400px; overflow-y: auto; padding: 15px;">
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-sync fa-spin me-2"></i>Waiting for connection...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Section -->
        <div id="control" class="section mt-4" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-gamepad me-2"></i>Advanced Control Panel</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-cogs me-2"></i>Manual Control</h6>
                            <div class="row g-3">
                                <div class="col-12">
                                    <button class="btn btn-primary-custom btn-custom w-100" onclick="manualControl('source1')">
                                        <i class="fas fa-play me-2"></i>Switch to Source 1
                                    </button>
                                </div>
                                <div class="col-12">
                                    <button class="btn btn-primary-custom btn-custom w-100" onclick="manualControl('source2')">
                                        <i class="fas fa-play me-2"></i>Switch to Source 2
                                    </button>
                                </div>
                                <div class="col-12">
                                    <button class="btn btn-danger-custom btn-custom w-100" onclick="manualControl('shutdown')">
                                        <i class="fas fa-stop me-2"></i>Complete Shutdown
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <h6><i class="fas fa-clock me-2"></i>Timed Actions</h6>
                                <div class="input-group mb-3">
                                    <span class="input-group-text">Delay</span>
                                    <input type="number" id="switch-delay" class="form-control" value="2000" min="100" max="10000">
                                    <span class="input-group-text">ms</span>
                                </div>
                                <button class="btn btn-info btn-custom w-100" onclick="scheduleSwitch()">
                                    <i class="fas fa-calendar-alt me-2"></i>Schedule Switch
                                </button>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h6><i class="fas fa-chart-bar me-2"></i>System Monitoring</h6>
                            <div class="row">
                                <div class="col-6">
                                    <div class="text-center mb-4">
                                        <div class="sensor-label">Source 1 Voltage</div>
                                        <div class="sensor-value">
                                            <span id="v1-detailed">0.0</span><span class="unit">V</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="text-center mb-4">
                                        <div class="sensor-label">Source 2 Voltage</div>
                                        <div class="sensor-value">
                                            <span id="v2-detailed">0.0</span><span class="unit">V</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <h6><i class="fas fa-sliders-h me-2"></i>Auto Mode Settings</h6>
                            <div class="row g-2">
                                <div class="col-6">
                                    <label class="form-label small">Switch Voltage</label>
                                    <div class="input-group">
                                        <input type="number" id="auto-switch-voltage" class="form-control" value="180">
                                        <span class="input-group-text">V</span>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small">Restore Voltage</label>
                                    <div class="input-group">
                                        <input type="number" id="auto-restore-voltage" class="form-control" value="190">
                                        <span class="input-group-text">V</span>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-success-custom btn-custom w-100 mt-3" onclick="updateAutoSettings()">
                                <i class="fas fa-save me-2"></i>Update Settings
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Optimalization Section -->
        <div id="optimalization" class="section mt-4" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-sliders-h me-2"></i>Sensor Optimalization</h5>
                </div>
                <div class="card-body">
                    <!-- Optimalization Status -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div id="optimalization-status" class="optimalization-status status-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>Optimalization Required
                            </div>
                        </div>
                    </div>
                    
                    <!-- Navigation Tabs -->
                    <ul class="nav nav-tabs" id="optimalizationTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="auto-tab" data-bs-toggle="tab" data-bs-target="#auto-tab-pane">
                                <i class="fas fa-robot me-2"></i>Auto Optimalization
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual-tab-pane">
                                <i class="fas fa-user-cog me-2"></i>Manual Optimalization
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="zero-tab" data-bs-toggle="tab" data-bs-target="#zero-tab-pane">
                                <i class="fas fa-bullseye me-2"></i>Zero Point
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="backup-tab" data-bs-toggle="tab" data-bs-target="#backup-tab-pane">
                                <i class="fas fa-database me-2"></i>Backup & Restore
                            </button>
                        </li>
                    </ul>
                    
                    <!-- Tab Content -->
                    <div class="tab-content" id="optimalizationTabsContent">
                        <!-- Auto Optimalization Tab -->
                        <div class="tab-pane fade show active" id="auto-tab-pane" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-info-circle me-2"></i>Instructions</h6>
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>Important:</strong> Ensure NO voltage is connected to any source during auto optimalization!
                                    </div>
                                    <ol class="small">
                                        <li>Disconnect all power sources</li>
                                        <li>Ensure all relays are OFF</li>
                                        <li>Do not touch the sensors during process</li>
                                        <li>Process takes about 15-20 seconds</li>
                                        <li>Data will be saved to flash memory</li>
                                    </ol>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-play-circle me-2"></i>Start Optimalization</h6>
                                    <div class="text-center">
                                        <button class="btn btn-warning-custom btn-custom w-100 mb-3" onclick="startAutoOptimalization()">
                                            <i class="fas fa-robot me-2"></i>Start Auto Optimalization
                                        </button>
                                        
                                        <div class="progress mb-3" style="height: 20px; display: none;" id="opt-progress-container">
                                            <div id="opt-progress" class="progress-bar progress-bar-custom" style="width: 0%">0%</div>
                                        </div>
                                        
                                        <div id="opt-status" class="small text-muted"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Manual Optimalization Tab -->
                        <div class="tab-pane fade" id="manual-tab-pane" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-bolt me-2"></i>Source 1 Optimalization</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Actual Voltage (measured with multimeter)</label>
                                        <div class="input-group">
                                            <input type="number" id="opt-v1-voltage" class="form-control" placeholder="e.g., 220.5" step="0.1" min="50" max="300">
                                            <span class="input-group-text">V</span>
                                        </div>
                                        <small class="text-muted">Range: 50V - 300V</small>
                                    </div>
                                    <button class="btn btn-primary-custom btn-custom w-100" onclick="manualOptimalization(1)">
                                        <i class="fas fa-sliders-h me-2"></i>Optimalize Source 1
                                    </button>
                                </div>
                                
                                <div class="col-md-6">
                                    <h6><i class="fas fa-bolt me-2"></i>Source 2 Optimalization</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Actual Voltage (measured with multimeter)</label>
                                        <div class="input-group">
                                            <input type="number" id="opt-v2-voltage" class="form-control" placeholder="e.g., 220.5" step="0.1" min="50" max="300">
                                            <span class="input-group-text">V</span>
                                        </div>
                                        <small class="text-muted">Range: 50V - 300V</small>
                                    </div>
                                    <button class="btn btn-primary-custom btn-custom w-100" onclick="manualOptimalization(2)">
                                        <i class="fas fa-sliders-h me-2"></i>Optimalize Source 2
                                    </button>
                                </div>
                            </div>
                            
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h6><i class="fas fa-chart-line me-2"></i>Current Optimalization Data</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Parameter</th>
                                                    <th>Zero Point</th>
                                                    <th>Optimal Factor</th>
                                                    <th>Voltage (V)</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>Source 1</td>
                                                    <td id="zero-v1">--</td>
                                                    <td id="factor-v1">--</td>
                                                    <td id="calc-v1">--</td>
                                                    <td><span id="status-v1" class="badge bg-secondary">--</span></td>
                                                </tr>
                                                <tr>
                                                    <td>Source 2</td>
                                                    <td id="zero-v2">--</td>
                                                    <td id="factor-v2">--</td>
                                                    <td id="calc-v2">--</td>
                                                    <td><span id="status-v2" class="badge bg-secondary">--</span></td>
                                                </tr>
                                                <tr>
                                                    <td>Current Sensor</td>
                                                    <td id="zero-i">--</td>
                                                    <td id="factor-i">--</td>
                                                    <td>--</td>
                                                    <td><span id="status-i" class="badge bg-secondary">--</span></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Zero Point Tab -->
                        <div class="tab-pane fade" id="zero-tab-pane" role="tabpanel">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h6><i class="fas fa-bolt text-warning me-2"></i>Source 1 Zero</h6>
                                            <div class="sensor-value mb-3">
                                                <span id="zero-v1-display">--</span>
                                            </div>
                                            <button class="btn btn-warning btn-custom w-100" onclick="resetZeroPoint(1)">
                                                <i class="fas fa-redo me-2"></i>Reset Zero Point
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h6><i class="fas fa-bolt text-warning me-2"></i>Source 2 Zero</h6>
                                            <div class="sensor-value mb-3">
                                                <span id="zero-v2-display">--</span>
                                            </div>
                                            <button class="btn btn-warning btn-custom w-100" onclick="resetZeroPoint(2)">
                                                <i class="fas fa-redo me-2"></i>Reset Zero Point
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h6><i class="fas fa-tachometer-alt text-info me-2"></i>Current Zero</h6>
                                            <div class="sensor-value mb-3">
                                                <span id="zero-i-display">--</span>
                                            </div>
                                            <button class="btn btn-info btn-custom w-100" onclick="resetZeroPoint(3)">
                                                <i class="fas fa-redo me-2"></i>Reset Zero Point
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Zero Point Explanation:</strong> This is the ADC reading when no voltage is applied. 
                                        It should be close to 2048 (midpoint of 12-bit ADC). If it's far from 2048, sensors may need recalibration.
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Backup & Restore Tab -->
                        <div class="tab-pane fade" id="backup-tab-pane" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-download me-2"></i>Backup Configuration</h6>
                                    <p class="small">Save current optimalization settings to a file.</p>
                                    <button class="btn btn-primary-custom btn-custom w-100 mb-3" onclick="backupSettings()">
                                        <i class="fas fa-file-export me-2"></i>Export Backup File
                                    </button>
                                    <button class="btn btn-success btn-custom w-100" onclick="saveToFlash()">
                                        <i class="fas fa-save me-2"></i>Save to ESP32 Flash
                                    </button>
                                </div>
                                
                                <div class="col-md-6">
                                    <h6><i class="fas fa-upload me-2"></i>Restore Configuration</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Upload Backup File</label>
                                        <input type="file" id="backup-file" class="form-control" accept=".json,.txt">
                                    </div>
                                    <button class="btn btn-warning-custom btn-custom w-100" onclick="restoreSettings()">
                                        <i class="fas fa-file-import me-2"></i>Restore from File
                                    </button>
                                </div>
                            </div>
                            
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h6><i class="fas fa-clipboard-list me-2"></i>Current Configuration</h6>
                                    <div class="card">
                                        <div class="card-body">
                                            <pre id="config-display" style="height: 200px; overflow-y: auto;" class="p-3 bg-light rounded"></pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settings" class="section mt-4" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-cog me-2"></i>System Settings</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6><i class="fas fa-wifi me-2"></i>WiFi Configuration</h6>
                            <div class="mb-3">
                                <label class="form-label">ESP32 IP Address</label>
                                <input type="text" id="esp-ip-input" class="form-control" value="10.191.170.230">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">WebSocket Port</label>
                                <input type="number" id="ws-port" class="form-control" value="80">
                            </div>
                            <button class="btn btn-primary-custom btn-custom w-100" onclick="updateConnectionSettings()">
                                <i class="fas fa-plug me-2"></i>Update Connection
                            </button>
                        </div>
                        
                        <div class="col-md-4">
                            <h6><i class="fas fa-bell me-2"></i>Notifications</h6>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="notify-switch" checked>
                                <label class="form-check-label">Switch Notifications</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="notify-fault" checked>
                                <label class="form-check-label">Fault Notifications</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="notify-optimalization" checked>
                                <label class="form-check-label">Optimalization Notifications</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="sound-alerts" checked>
                                <label class="form-check-label">Sound Alerts</label>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <h6><i class="fas fa-palette me-2"></i>Theme Settings</h6>
                            <div class="mb-3">
                                <label class="form-label">Theme Color</label>
                                <select id="theme-select" class="form-select">
                                    <option value="default">Default (Purple)</option>
                                    <option value="blue">Blue</option>
                                    <option value="green">Green</option>
                                    <option value="red">Red</option>
                                    <option value="dark">Dark Mode</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Update Interval</label>
                                <select id="update-interval" class="form-select">
                                    <option value="1000">1 Second</option>
                                    <option value="2000" selected>2 Seconds</option>
                                    <option value="5000">5 Seconds</option>
                                    <option value="10000">10 Seconds</option>
                                </select>
                            </div>
                            <button class="btn btn-success btn-custom w-100" onclick="applyThemeSettings()">
                                <i class="fas fa-paint-brush me-2"></i>Apply Theme
                            </button>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <h6><i class="fas fa-tools me-2"></i>System Tools</h6>
                            <div class="row g-2">
                                <div class="col-md-3">
                                    <button class="btn btn-outline-primary btn-custom w-100" onclick="testSensorAccuracy()">
                                        <i class="fas fa-vial me-2"></i>Test Sensors
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-outline-warning btn-custom w-100" onclick="resetEnergyCounter()">
                                        <i class="fas fa-redo me-2"></i>Reset Energy
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-outline-info btn-custom w-100" onclick="generateReport()">
                                        <i class="fas fa-file-pdf me-2"></i>Generate Report
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-outline-danger btn-custom w-100" onclick="emergencyReset()">
                                        <i class="fas fa-skull-crossbones me-2"></i>Emergency Reset
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Floating Action Button -->
    <button class="floating-action-btn" id="fab" data-bs-toggle="modal" data-bs-target="#quickControlModal">
        <i class="fas fa-bolt"></i>
        <span id="notification-badge" class="notification-badge" style="display: none;">0</span>
    </button>

    <!-- Quick Control Modal -->
    <div class="modal fade modal-custom" id="quickControlModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-bolt me-2"></i>Quick Control</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <button class="btn btn-success-custom btn-custom w-100" onclick="quickControl('source1')">
                                <i class="fas fa-play me-2"></i>Source 1
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-warning-custom btn-custom w-100" onclick="quickControl('source2')">
                                <i class="fas fa-play me-2"></i>Source 2
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-danger-custom btn-custom w-100" onclick="quickControl('shutdown')">
                                <i class="fas fa-stop me-2"></i>Shutdown
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-info btn-custom w-100" onclick="quickControl('optimalize')">
                                <i class="fas fa-sliders-h me-2"></i>Optimalize
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h6><i class="fas fa-chart-line me-2"></i>Quick Status</h6>
                        <div class="row">
                            <div class="col-4 text-center">
                                <small>V1</small>
                                <div class="fw-bold" id="quick-v1">0.0V</div>
                            </div>
                            <div class="col-4 text-center">
                                <small>V2</small>
                                <div class="fw-bold" id="quick-v2">0.0V</div>
                            </div>
                            <div class="col-4 text-center">
                                <small>State</small>
                                <div class="fw-bold" id="quick-state">OFF</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Optimalization Progress Modal -->
    <div class="modal fade modal-custom" id="optimalizationModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-robot me-2"></i>Optimalization in Progress</h5>
                </div>
                <div class="modal-body text-center">
                    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5 id="opt-modal-title">Initializing...</h5>
                    <div class="progress mb-3" style="height: 20px;">
                        <div id="opt-modal-progress" class="progress-bar progress-bar-custom" style="width: 0%">0%</div>
                    </div>
                    <p id="opt-modal-message" class="text-muted">Please wait while we optimalize the sensors...</p>
                    <div id="opt-modal-details" class="small text-muted"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="cancelOptimalization()">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gauge-chart@latest/dist/bundle.js"></script>

    <script>
        // ========== GLOBAL VARIABLES ==========
        const DEFAULT_ESP_IP = "10.191.170.230";
        const WS_PORT = 80;
        
        let ws = null;
        let wsReconnectInterval = null;
        let autoScrollLog = true;
        let notificationCount = 0;
        let optimalizationInProgress = false;
        let uptimeTimer = null;
        
        // ========== WEBSOCKET FUNCTIONS ==========
        function connectWebSocket() {
            const espIp = localStorage.getItem('esp_ip') || DEFAULT_ESP_IP;
            const port = localStorage.getItem('ws_port') || WS_PORT;
            const wsUrl = `ws://${espIp}:${port}/ws`;
            
            console.log(`Connecting to WebSocket: ${wsUrl}`);
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log(" WebSocket connected!");
                updateConnectionStatus(true, "Connected to ESP32");
                addLog("WebSocket connection established", "success");
                
                // Clear reconnect interval
                if (wsReconnectInterval) {
                    clearInterval(wsReconnectInterval);
                    wsReconnectInterval = null;
                }
                
                // Request initial data
                requestSystemData();
            };
            
            ws.onclose = function(event) {
                console.log(" WebSocket disconnected:", event.code, event.reason);
                updateConnectionStatus(false, "Disconnected from ESP32");
                addLog("WebSocket disconnected", "danger");
                
                // Attempt to reconnect every 5 seconds
                if (!wsReconnectInterval) {
                    wsReconnectInterval = setInterval(connectWebSocket, 5000);
                }
            };
            
            ws.onerror = function(error) {
                console.error("WebSocket error:", error);
                addLog(`WebSocket error: ${error}`, "danger");
            };
            
            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (e) {
                    console.log("Raw message:", event.data);
                }
            };
        }
        
        function handleWebSocketMessage(data) {
            // Update sensor readings
            if (data.voltage1 !== undefined) {
                updateSensorReadings(data);
            }
            
            // Update system state
            if (data.stateText !== undefined) {
                updateSystemState(data);
            }
            
            // Update optimalization data
            if (data.optimal !== undefined) {
                updateOptimalizationData(data.optimal);
            }
            
            // Handle different message types
            if (data.type) {
                switch(data.type) {
                    case 'state_changed':
                        addLog(`System state changed to: ${data.stateText}`, "info");
                        showNotification(`State changed to ${data.stateText}`);
                        break;
                        
                    case 'emergency_shutdown':
                        addLog(` EMERGENCY SHUTDOWN: ${data.reason}`, "danger");
                        showNotification(` Emergency: ${data.reason}`, "danger");
                        break;
                        
                    case 'optimalization_start':
                        showOptimalizationModal("Starting optimalization...", 0);
                        addLog("Optimalization process started", "info");
                        break;
                        
                    case 'optimalization_progress':
                        updateOptimalizationProgress(data.progress);
                        break;
                        
                    case 'optimalization_complete':
                        hideOptimalizationModal();
                        addLog(" Optimalization complete!", "success");
                        showNotification("Optimalization complete!", "success");
                        break;
                        
                    case 'manual_optimal_complete':
                        hideOptimalizationModal();
                        const error = data.errorPercent || 0;
                        const quality = error < 5 ? "success" : (error < 10 ? "warning" : "danger");
                        addLog(`Manual optimalization complete. Error: ${error.toFixed(1)}%`, quality);
                        break;
                        
                    case 'zero_point_complete':
                        addLog(`Zero point reset for source ${data.source}`, "info");
                        break;
                        
                    case 'mode_changed':
                        const modeText = data.mode === 'auto' ? 'Auto Mode' : 'Maintenance Mode';
                        const statusText = data.enabled ? 'enabled' : 'disabled';
                        addLog(`${modeText} ${statusText}`, "info");
                        break;
                        
                    case 'optimalization_saved':
                        addLog("Optimalization data saved to flash", "success");
                        break;
                        
                    case 'optimalization_reset':
                        addLog("Optimalization reset to default values", "warning");
                        break;
                }
            }
            
            // Update UI with general data
            if (data.wifiSignal !== undefined) {
                document.getElementById('wifi-rssi').textContent = data.wifiSignal;
            }
            
            if (data.uptime !== undefined) {
                updateUptimeDisplay(data.uptime);
            }
        }
        
        function requestSystemData() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                // Request system status
                ws.send(JSON.stringify({ command: "get_status" }));
                
                // Request optimalization data
                ws.send(JSON.stringify({ command: "get_optimalization" }));
            }
        }
        
        // ========== UI UPDATE FUNCTIONS ==========
        function updateSensorReadings(data) {
            // Update main dashboard
            document.getElementById('voltage1').textContent = data.voltage1.toFixed(1);
            document.getElementById('voltage2').textContent = data.voltage2.toFixed(1);
            document.getElementById('current').textContent = data.current.toFixed(3);
            document.getElementById('power').textContent = data.power.toFixed(1);
            document.getElementById('energy').textContent = data.energy.toFixed(3);
            
            // Update detailed view
            document.getElementById('v1-detailed').textContent = data.voltage1.toFixed(1);
            document.getElementById('v2-detailed').textContent = data.voltage2.toFixed(1);
            
            // Update quick view
            document.getElementById('quick-v1').textContent = data.voltage1.toFixed(1) + 'V';
            document.getElementById('quick-v2').textContent = data.voltage2.toFixed(1) + 'V';
            
            // Update voltage status badges
            updateVoltageStatus('v1-status', data.voltage1);
            updateVoltageStatus('v2-status', data.voltage2);
            
            // Update energy progress bar
            const energyProgress = Math.min((data.energy / 10) * 100, 100); // Assuming 10kWh max for progress
            document.getElementById('energy-progress').style.width = energyProgress + '%';
        }
        
        function updateSystemState(data) {
            const stateText = data.stateText || getStateText(data.state);
            const stateBadge = document.getElementById('system-state-badge');
            const quickState = document.getElementById('quick-state');
            
            // Update badges
            stateBadge.textContent = `STATE: ${stateText}`;
            quickState.textContent = stateText.split(' ')[0]; // Just first word for quick view
            
            // Update colors based on state
            stateBadge.className = 'state-badge ';
            if (stateText.includes('AKTIF')) {
                stateBadge.classList.add('bg-success');
            } else if (stateText.includes('OFF')) {
                stateBadge.classList.add('bg-secondary');
            } else if (stateText.includes('SWITCHING')) {
                stateBadge.classList.add('bg-warning');
            } else if (stateText.includes('FAULT')) {
                stateBadge.classList.add('bg-danger');
            }
            
            // Update mode switches
            if (data.autoMode !== undefined) {
                document.getElementById('auto-mode-switch').checked = data.autoMode;
            }
            
            if (data.maintenanceMode !== undefined) {
                document.getElementById('maintenance-switch').checked = data.maintenanceMode;
            }
        }
        
        function updateOptimalizationData(optimal) {
            // Update zero points
            document.getElementById('zero-v1').textContent = optimal.zeroV1 || '--';
            document.getElementById('zero-v2').textContent = optimal.zeroV2 || '--';
            document.getElementById('zero-i').textContent = optimal.zeroI || '--';
            
            // Update zero point displays
            document.getElementById('zero-v1-display').textContent = optimal.zeroV1 || '--';
            document.getElementById('zero-v2-display').textContent = optimal.zeroV2 || '--';
            document.getElementById('zero-i-display').textContent = optimal.zeroI || '--';
            
            // Update optimal factors
            document.getElementById('factor-v1').textContent = optimal.factorV1 ? optimal.factorV1.toFixed(4) : '--';
            document.getElementById('factor-v2').textContent = optimal.factorV2 ? optimal.factorV2.toFixed(4) : '--';
            document.getElementById('factor-i').textContent = optimal.factorI ? optimal.factorI.toFixed(4) : '--';
            
            // Calculate and display voltages
            if (optimal.zeroV1 && optimal.factorV1) {
                // Simplified calculation for display
                const calcV1 = (optimal.zeroV1 * 0.8).toFixed(1); // Placeholder calculation
                document.getElementById('calc-v1').textContent = calcV1 + 'V';
                document.getElementById('status-v1').className = 'badge ' + (Math.abs(optimal.factorV1 - 1) < 0.1 ? 'bg-success' : 'bg-warning');
                document.getElementById('status-v1').textContent = Math.abs(optimal.factorV1 - 1) < 0.1 ? 'OK' : 'CHECK';
            }
            
            if (optimal.zeroV2 && optimal.factorV2) {
                const calcV2 = (optimal.zeroV2 * 0.8).toFixed(1);
                document.getElementById('calc-v2').textContent = calcV2 + 'V';
                document.getElementById('status-v2').className = 'badge ' + (Math.abs(optimal.factorV2 - 1) < 0.1 ? 'bg-success' : 'bg-warning');
                document.getElementById('status-v2').textContent = Math.abs(optimal.factorV2 - 1) < 0.1 ? 'OK' : 'CHECK';
            }
            
            // Update optimalization status
            updateOptimalizationStatus(optimal.status);
            
            // Update configuration display
            updateConfigDisplay(optimal);
        }
        
        function updateOptimalizationStatus(status) {
            const statusDiv = document.getElementById('optimalization-status');
            if (!status) return;
            
            statusDiv.innerHTML = `<i class="fas fa-${getStatusIcon(status)} me-2"></i>${status}`;
            
            if (status.includes('') || status === 'OK') {
                statusDiv.className = 'optimalization-status status-good';
            } else if (status.includes('')) {
                statusDiv.className = 'optimalization-status status-warning';
            } else {
                statusDiv.className = 'optimalization-status status-danger';
            }
        }
        
        function getStatusIcon(status) {
            if (status.includes('') || status === 'OK') return 'check-circle';
            if (status.includes('')) return 'exclamation-triangle';
            return 'exclamation-circle';
        }
        
        function getStateText(state) {
            const states = {
                0: ' OFF',
                1: ' SUMBER 1 AKTIF',
                2: ' SUMBER 2 AKTIF',
                3: ' SEDANG SWITCHING',
                4: ' FAULT'
            };
            return states[state] || ' UNKNOWN';
        }
        
        function updateVoltageStatus(elementId, voltage) {
            const element = document.getElementById(elementId);
            if (voltage < 50) {
                element.textContent = 'OFF';
                element.className = 'badge bg-secondary';
            } else if (voltage < 180) {
                element.textContent = 'LOW';
                element.className = 'badge bg-warning';
            } else if (voltage > 250) {
                element.textContent = 'HIGH';
                element.className = 'badge bg-danger';
            } else {
                element.textContent = 'OK';
                element.className = 'badge bg-success';
            }
        }
        
        // ========== CONTROL FUNCTIONS ==========
        function controlSwitch(command) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                showAlert('Not connected to ESP32!', 'danger');
                return;
            }
            
            let message = {};
            switch(command) {
                case 'source1':
                    message = { command: "switch_source", value: "1" };
                    addLog("Command sent: Activate Source 1", "info");
                    break;
                case 'source2':
                    message = { command: "switch_source", value: "2" };
                    addLog("Command sent: Activate Source 2", "info");
                    break;
                case 'shutdown':
                    if (confirm(' Are you sure you want to emergency shutdown?')) {
                        message = { command: "switch_source", value: "0" };
                        addLog("Command sent: Emergency Shutdown", "danger");
                    } else {
                        return;
                    }
                    break;
            }
            
            ws.send(JSON.stringify(message));
        }
        
        function manualControl(command) {
            const delay = parseInt(document.getElementById('switch-delay').value) || 2000;
            
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                showAlert('Not connected to ESP32!', 'danger');
                return;
            }
            
            let message = {};
            switch(command) {
                case 'source1':
                    message = { 
                        command: "manual_switch", 
                        value: "1",
                        delay: delay 
                    };
                    addLog(`Manual switch to Source 1 with ${delay}ms delay`, "info");
                    break;
                case 'source2':
                    message = { 
                        command: "manual_switch", 
                        value: "2",
                        delay: delay 
                    };
                    addLog(`Manual switch to Source 2 with ${delay}ms delay`, "info");
                    break;
                case 'shutdown':
                    message = { 
                        command: "manual_switch", 
                        value: "0",
                        delay: 1000 
                    };
                    addLog("Manual complete shutdown", "warning");
                    break;
            }
            
            ws.send(JSON.stringify(message));
        }
        
        function quickControl(command) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('quickControlModal'));
            if (modal) modal.hide();
            
            switch(command) {
                case 'source1':
                case 'source2':
                case 'shutdown':
                    controlSwitch(command);
                    break;
                case 'optimalize':
                    startAutoOptimalization();
                    break;
            }
        }
        
        function toggleMode(mode) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                showAlert('Not connected to ESP32!', 'danger');
                return;
            }
            
            const isAutoMode = document.getElementById('auto-mode-switch').checked;
            const isMaintenance = document.getElementById('maintenance-switch').checked;
            
            let message = {};
            if (mode === 'auto') {
                message = { 
                    command: "toggle_mode", 
                    value: "auto",
                    enabled: isAutoMode 
                };
                addLog(`Auto Mode ${isAutoMode ? 'enabled' : 'disabled'}`, "info");
            } else if (mode === 'maintenance') {
                message = { 
                    command: "toggle_mode", 
                    value: "maintenance",
                    enabled: isMaintenance 
                };
                addLog(`Maintenance Mode ${isMaintenance ? 'enabled' : 'disabled'}`, "info");
            }
            
            ws.send(JSON.stringify(message));
        }
        
        // ========== OPTIMALIZATION FUNCTIONS ==========
        function startAutoOptimalization() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                showAlert('Not connected to ESP32!', 'danger');
                return;
            }
            
            if (!confirm(' WARNING: Auto Optimalization\n\n1. Ensure NO voltage is connected\n2. All relays must be OFF\n3. Do not touch sensors during process\n\nProceed?')) {
                return;
            }
            
            const message = { 
                command: "optimalization", 
                value: "auto" 
            };
            
            ws.send(JSON.stringify(message));
            optimalizationInProgress = true;
        }
        
        function manualOptimalization(source) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                showAlert('Not connected to ESP32!', 'danger');
                return;
            }
            
            const voltageInput = source === 1 ? 'opt-v1-voltage' : 'opt-v2-voltage';
            const voltage = parseFloat(document.getElementById(voltageInput).value);
            
            if (!voltage || voltage < 50 || voltage > 300) {
                showAlert('Please enter a valid voltage between 50V and 300V', 'warning');
                return;
            }
            
            if (!confirm(` Manual Optimalization for Source ${source}\n\nMeasured voltage: ${voltage}V\n\nProceed?`)) {
                return;
            }
            
            const message = { 
                command: "manual_optimal", 
                source: source,
                voltage: voltage 
            };
            
            ws.send(JSON.stringify(message));
            optimalizationInProgress = true;
        }
        
        function resetZeroPoint(source) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                showAlert('Not connected to ESP32!', 'danger');
                return;
            }
            
            const sourceNames = {1: 'Source 1', 2: 'Source 2', 3: 'Current Sensor'};
            const sourceName = sourceNames[source];
            
            if (!confirm(` Reset Zero Point for ${sourceName}\n\nEnsure NO voltage/current during this process!\n\nProceed?`)) {
                return;
            }
            
            const message = { 
                command: "reset_zero", 
                source: source 
            };
            
            ws.send(JSON.stringify(message));
            addLog(`Zero point reset requested for ${sourceName}`, "info");
        }
        
        function saveToFlash() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                showAlert('Not connected to ESP32!', 'danger');
                return;
            }
            
            const message = { 
                command: "optimalization", 
                value: "save" 
            };
            
            ws.send(JSON.stringify(message));
            addLog("Saving optimalization data to flash...", "info");
        }
        
        // ========== MODAL FUNCTIONS ==========
        function showOptimalizationModal(title, progress) {
            document.getElementById('opt-modal-title').textContent = title;
            document.getElementById('opt-modal-progress').style.width = progress + '%';
            document.getElementById('opt-modal-progress').textContent = progress + '%';
            
            const modal = new bootstrap.Modal(document.getElementById('optimalizationModal'));
            modal.show();
        }
        
        function updateOptimalizationProgress(progress) {
            document.getElementById('opt-modal-progress').style.width = progress + '%';
            document.getElementById('opt-modal-progress').textContent = progress + '%';
            
            // Update progress message
            let message = "Optimalization in progress...";
            if (progress < 30) message = "Collecting zero point samples...";
            else if (progress < 60) message = "Calculating optimal factors...";
            else if (progress < 90) message = "Verifying optimalization...";
            else message = "Saving to flash memory...";
            
            document.getElementById('opt-modal-message').textContent = message;
        }
        
        function hideOptimalizationModal() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('optimalizationModal'));
            if (modal) modal.hide();
            optimalizationInProgress = false;
        }
        
        function cancelOptimalization() {
            if (optimalizationInProgress && ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ command: "cancel_optimalization" }));
                addLog("Optimalization cancelled by user", "warning");
            }
            hideOptimalizationModal();
        }
        
        // ========== UTILITY FUNCTIONS ==========
        function updateConnectionStatus(connected, message) {
            const indicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('connection-status');
            const wsStatus = document.getElementById('ws-status');
            
            if (connected) {
                indicator.className = 'status-indicator status-online';
                statusText.textContent = message;
                wsStatus.textContent = 'Connected';
                wsStatus.style.color = 'var(--success-color)';
            } else {
                indicator.className = 'status-indicator status-offline';
                statusText.textContent = message;
                wsStatus.textContent = 'Disconnected';
                wsStatus.style.color = 'var(--danger-color)';
            }
        }
        
        function addLog(message, type = 'info') {
            const logPanel = document.getElementById('log-panel');
            const timestamp = new Date().toLocaleTimeString();
            
            // Remove loading message if present
            if (logPanel.children.length === 1 && logPanel.children[0].classList.contains('text-center')) {
                logPanel.innerHTML = '';
            }
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `
                <small class="text-muted">[${timestamp}]</small>
                <span class="ms-2">${message}</span>
            `;
            
            logPanel.appendChild(logEntry);
            
            // Auto-scroll to bottom
            if (autoScrollLog) {
                logPanel.scrollTop = logPanel.scrollHeight;
            }
            
            // Keep only last 100 log entries
            const entries = logPanel.getElementsByClassName('log-entry');
            if (entries.length > 100) {
                entries[0].remove();
            }
            
            // Update notification badge
            if (type === 'danger' || type === 'warning') {
                notificationCount++;
                updateNotificationBadge();
            }
        }
        
        function clearLog() {
            if (confirm('Clear all log entries?')) {
                document.getElementById('log-panel').innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-clipboard me-2"></i>Log cleared
                    </div>
                `;
                addLog("Log cleared by user", "info");
            }
        }
        
        function toggleAutoScroll() {
            autoScrollLog = !autoScrollLog;
            const icon = document.getElementById('scroll-icon');
            icon.className = autoScrollLog ? 'fas fa-scroll' : 'fas fa-scroll text-danger';
            addLog(`Auto-scroll ${autoScrollLog ? 'enabled' : 'disabled'}`, "info");
        }
        
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Add to top of body
            document.body.insertBefore(alertDiv, document.body.firstChild);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
        
        function showNotification(message, type = 'info') {
            // Check if notifications are enabled
            const notifySwitch = document.getElementById('notify-switch');
            if (notifySwitch && !notifySwitch.checked) return;
            
            // Check if sound alerts are enabled
            const soundAlerts = document.getElementById('sound-alerts');
            if (soundAlerts && soundAlerts.checked) {
                playNotificationSound(type);
            }
            
            // Create notification
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Power Switch System', {
                    body: message,
                    icon: '/favicon.ico'
                });
            }
        }
        
        function playNotificationSound(type) {
            const audio = new Audio();
            if (type === 'danger') {
                audio.src = 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA=='; // Simple beep
            }
            audio.play();
        }
        
        function updateNotificationBadge() {
            const badge = document.getElementById('notification-badge');
            if (notificationCount > 0) {
                badge.textContent = notificationCount > 9 ? '9+' : notificationCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }
        
        function updateUptimeDisplay(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            document.getElementById('uptime-display').innerHTML = `
                <i class="fas fa-clock me-1"></i>
                Uptime: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}
            `;
        }
        
        // ========== SETTINGS FUNCTIONS ==========
        function updateConnectionSettings() {
            const espIp = document.getElementById('esp-ip-input').value;
            const wsPort = document.getElementById('ws-port').value;
            
            if (!espIp || !wsPort) {
                showAlert('Please enter valid IP and port', 'warning');
                return;
            }
            
            localStorage.setItem('esp_ip', espIp);
            localStorage.setItem('ws_port', wsPort);
            
            showAlert('Connection settings saved. Reconnecting...', 'success');
            
            // Reconnect with new settings
            if (wsReconnectInterval) {
                clearInterval(wsReconnectInterval);
                wsReconnectInterval = null;
            }
            
            if (ws) {
                ws.close();
            }
            
            setTimeout(connectWebSocket, 1000);
        }
        
        function applyThemeSettings() {
            const theme = document.getElementById('theme-select').value;
            const updateInterval = document.getElementById('update-interval').value;
            
            localStorage.setItem('theme', theme);
            localStorage.setItem('update_interval', updateInterval);
            
            applyTheme(theme);
            showAlert('Theme settings applied', 'success');
        }
        
        function applyTheme(theme) {
            const root = document.documentElement;
            
            switch(theme) {
                case 'blue':
                    root.style.setProperty('--primary-color', '#2196F3');
                    root.style.setProperty('--secondary-color', '#1976D2');
                    break;
                case 'green':
                    root.style.setProperty('--primary-color', '#4CAF50');
                    root.style.setProperty('--secondary-color', '#388E3C');
                    break;
                case 'red':
                    root.style.setProperty('--primary-color', '#F44336');
                    root.style.setProperty('--secondary-color', '#D32F2F');
                    break;
                case 'dark':
                    root.style.setProperty('--primary-color', '#333333');
                    root.style.setProperty('--secondary-color', '#222222');
                    document.body.style.background = '#121212';
                    document.body.style.color = '#ffffff';
                    break;
                default:
                    root.style.setProperty('--primary-color', '#667eea');
                    root.style.setProperty('--secondary-color', '#764ba2');
                    document.body.style.background = 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)';
                    document.body.style.color = '#000000';
            }
        }
        
        // ========== BACKUP FUNCTIONS ==========
        function backupSettings() {
            const config = {
                timestamp: new Date().toISOString(),
                esp_ip: localStorage.getItem('esp_ip') || DEFAULT_ESP_IP,
                theme: localStorage.getItem('theme') || 'default',
                update_interval: localStorage.getItem('update_interval') || '2000'
            };
            
            const dataStr = JSON.stringify(config, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `power-switch-backup-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            addLog("Configuration backup exported", "success");
        }
        
        function restoreSettings() {
            const fileInput = document.getElementById('backup-file');
            if (!fileInput.files.length) {
                showAlert('Please select a backup file', 'warning');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const config = JSON.parse(e.target.result);
                    
                    // Restore settings
                    if (config.esp_ip) localStorage.setItem('esp_ip', config.esp_ip);
                    if (config.theme) {
                        localStorage.setItem('theme', config.theme);
                        applyTheme(config.theme);
                    }
                    if (config.update_interval) {
                        localStorage.setItem('update_interval', config.update_interval);
                        document.getElementById('update-interval').value = config.update_interval;
                    }
                    
                    showAlert('Settings restored successfully', 'success');
                    addLog("Configuration restored from backup", "success");
                    
                } catch (error) {
                    showAlert('Invalid backup file format', 'danger');
                    console.error(error);
                }
            };
            
            reader.readAsText(file);
        }
        
        function updateConfigDisplay(optimal) {
            const config = {
                timestamp: new Date().toISOString(),
                optimalization: optimal,
                connection: {
                    esp_ip: localStorage.getItem('esp_ip') || DEFAULT_ESP_IP,
                    ws_port: localStorage.getItem('ws_port') || WS_PORT
                },
                settings: {
                    theme: localStorage.getItem('theme') || 'default',
                    update_interval: localStorage.getItem('update_interval') || '2000'
                }
            };
            
            document.getElementById('config-display').textContent = JSON.stringify(config, null, 2);
        }
        
        // ========== SYSTEM TOOLS ==========
        function testSensorAccuracy() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                showAlert('Not connected to ESP32!', 'danger');
                return;
            }
            
            const message = { 
                command: "test_sensors" 
            };
            
            ws.send(JSON.stringify(message));
            addLog("Sensor accuracy test requested", "info");
        }
        
        function resetEnergyCounter() {
            if (confirm(' Reset energy consumption counter?\n\nThis action cannot be undone.')) {
                if (!ws || ws.readyState !== WebSocket.OPEN) {
                    showAlert('Not connected to ESP32!', 'danger');
                    return;
                }
                
                const message = { 
                    command: "reset_energy" 
                };
                
                ws.send(JSON.stringify(message));
                addLog("Energy counter reset requested", "warning");
            }
        }
        
        function generateReport() {
            const report = {
                generated: new Date().toISOString(),
                system: {
                    voltage1: document.getElementById('voltage1').textContent,
                    voltage2: document.getElementById('voltage2').textContent,
                    current: document.getElementById('current').textContent,
                    power: document.getElementById('power').textContent,
                    energy: document.getElementById('energy').textContent,
                    state: document.getElementById('system-state-badge').textContent
                },
                optimalization: {
                    status: document.getElementById('optimalization-status').textContent
                }
            };
            
            const dataStr = JSON.stringify(report, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `system-report-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            addLog("System report generated", "success");
        }
        
        function emergencyReset() {
            if (confirm(' EMERGENCY RESET\n\nThis will:\n1. Reset all optimalization data\n2. Clear energy counter\n3. Reset to factory defaults\n\nARE YOU SURE?')) {
                if (!ws || ws.readyState !== WebSocket.OPEN) {
                    showAlert('Not connected to ESP32!', 'danger');
                    return;
                }
                
                const message = { 
                    command: "emergency_reset" 
                };
                
                ws.send(JSON.stringify(message));
                addLog("EMERGENCY RESET initiated", "danger");
            }
        }
        
        // ========== NAVIGATION FUNCTIONS ==========
        function setupNavigation() {
            // Handle navbar clicks
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    // Add active class to clicked
                    this.classList.add('active');
                    
                    // Hide all sections
                    document.querySelectorAll('.section').forEach(section => {
                        section.style.display = 'none';
                    });
                    
                    // Show target section
                    const targetId = this.getAttribute('href').substring(1);
                    document.getElementById(targetId).style.display = 'block';
                });
            });
        }
        
        // ========== INITIALIZATION ==========
        function initialize() {
            // Load saved settings
            const savedTheme = localStorage.getItem('theme') || 'default';
            const savedUpdateInterval = localStorage.getItem('update_interval') || '2000';
            
            document.getElementById('theme-select').value = savedTheme;
            document.getElementById('update-interval').value = savedUpdateInterval;
            document.getElementById('esp-ip-input').value = localStorage.getItem('esp_ip') || DEFAULT_ESP_IP;
            document.getElementById('ws-port').value = localStorage.getItem('ws_port') || WS_PORT;
            
            // Apply theme
            applyTheme(savedTheme);
            
            // Setup navigation
            setupNavigation();
            
            // Request notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // Connect WebSocket
            connectWebSocket();
            
            // Start uptime timer
            uptimeTimer = setInterval(() => {
                const uptimeElement = document.getElementById('uptime-display');
                if (uptimeElement.textContent.includes('--')) return;
                
                const timeParts = uptimeElement.textContent.split(':').slice(-3);
                let seconds = parseInt(timeParts[2]);
                let minutes = parseInt(timeParts[1]);
                let hours = parseInt(timeParts[0].split(' ').pop());
                
                seconds++;
                if (seconds >= 60) {
                    seconds = 0;
                    minutes++;
                    if (minutes >= 60) {
                        minutes = 0;
                        hours++;
                    }
                }
                
                uptimeElement.innerHTML = `
                    <i class="fas fa-clock me-1"></i>
                    Uptime: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}
                `;
            }, 1000);
            
            // Add initial log
            addLog("System initialized. Web interface ready.", "success");
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initialize);
        
        // Handle page visibility change
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && ws && ws.readyState !== WebSocket.OPEN) {
                connectWebSocket();
            }
        });
    </script>
</body>
</html>
